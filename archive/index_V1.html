<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medicine Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .progress { font-weight: bold; }
    button { margin: 10px; padding: 10px 15px; }
  </style>
</head>
<body>
  <h2>30-Day Medicine Progress Dashboard</h2>

  <table id="dash">
    <thead>
      <tr>
        <th>Day</th>
        <th>Date</th>
        <th>Morning</th>
        <th>Afternoon</th>
        <th>Evening</th>
        <th>Night</th>
        <th>Progress</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be generated by JS -->
    </tbody>
  </table>

  <div style="text-align:center;">
    <button onclick="saveAll()">Save Progress</button>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzVD4-d_qosjhbByFAsH87PrMj6jIEKTp_GKlAOZ199lKy0pHX3DAT7oADHVXcVVy8euw/exec"; // <-- replace this

  // generate 30 rows initially
  function generateRows() {
    const tbody = document.querySelector("#dash tbody");
    const today = new Date();
    for (let i=1; i<=30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + (i-1));
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i}</td>
        <td>${date.toISOString().split("T")[0]}</td>
        <td><input type="checkbox" class="cb" data-time="Morning" onchange="updateRow(this.closest('tr'))"></td>
        <td><input type="checkbox" class="cb" data-time="Afternoon" onchange="updateRow(this.closest('tr'))"></td>
        <td><input type="checkbox" class="cb" data-time="Evening" onchange="updateRow(this.closest('tr'))"></td>
        <td><input type="checkbox" class="cb" data-time="Night" onchange="updateRow(this.closest('tr'))"></td>
        <td class="progress">0%</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function updateRow(tr) {
    const inputs = Array.from(tr.querySelectorAll("input.cb"));
    const total = inputs.length;
    const done = inputs.filter(i=>i.checked).length;
    tr.querySelector(".progress").innerText = Math.round(done/total*100) + "%";
  }

  async function load() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();

      document.querySelectorAll('#dash tbody tr').forEach((tr, idx) => {
        if (idx+1 < data.length) {
          const row = data[idx+1]; // skip header row
          const vals = {Morning: row[2], Afternoon: row[3], Evening: row[4], Night: row[5]};
          tr.querySelectorAll('input.cb').forEach(cb => {
            cb.checked = vals[cb.dataset.time] == 1;
          });
          updateRow(tr);
        }
      });
    } catch (e) {
      console.error("Error loading data:", e);
    }
  }

  async function saveAll() {
    document.querySelectorAll("#dash tbody tr").forEach(async (tr, idx) => {
      const day = idx + 1;
      const payload = {
        day: day,
        morning: tr.querySelector("input[data-time='Morning']").checked ? 1 : 0,
        afternoon: tr.querySelector("input[data-time='Afternoon']").checked ? 1 : 0,
        evening: tr.querySelector("input[data-time='Evening']").checked ? 1 : 0,
        night: tr.querySelector("input[data-time='Night']").checked ? 1 : 0
      };
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });
    });
    alert("Progress saved successfully.");
  }

  window.onload = () => { 
    generateRows();
    load(); 
  };
  </script>
</body>
</html>
